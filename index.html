<!DOCTYPE html>
<html>
  <head>
    <title>ArcGIS API for JavaScript Sample with Location Search</title>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.29/esri/themes/light/main.css"
    />
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        font-family: sans-serif;
      }

      #map-area {
        width: 100%;
        height: 90%;
      }

      .search-container {
        padding: 10px;
        background-color: white;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
      }

      .results {
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        background: white;
      }

      .result-item {
        padding: 5px;
        cursor: pointer;
      }

      .result-item:hover {
        background-color: #f0f0f0;
      }

      .copyright-url {
        position: absolute;
        bottom: 5px;
        right: 40px;
        padding: 0 4px;
        font-family: sans-serif;
        font-size: 12px;
      }

      .copyright-logo {
        position: absolute;
        bottom: 5px;
        right: 10px;
        width: 28px;
        height: 28px;
        display: inline-flex;
        background: url;
        background-size: 28px;
      }
    </style>
  </head>

  <body>
    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search location..." />
      <div class="results" id="results-container"></div>
    </div>
    <script src="https://js.arcgis.com/4.29/"></script>
    <div id="map-area"></div>
    <script>
      require([
        "esri/Map",
        "esri/Basemap",
        "esri/layers/VectorTileLayer",
        "esri/views/MapView",
        "esri/geometry/SpatialReference",
        "esri/geometry/Point",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
      ], function (
        Map,
        Basemap,
        VectorTileLayer,
        MapView,
        SpatialReference,
        Point,
        GraphicsLayer,
        Graphic
      ) {
        const basemapVTURL =
          "https://mapapi.geodata.gov.hk/gs/api/v1.0.0/vt/basemap/HK80";
        const mapLabelVTUrl =
          "https://mapapi.geodata.gov.hk/gs/api/v1.0.0/vt/label/hk/tc/HK80";

        const basemap = new Basemap({
          baseLayers: [
            new VectorTileLayer({
              url: basemapVTURL,
              copyright:
                '<a href="https://api.portal.hkmapservice.gov.hk/disclaimer" target="_blank" class="copyright-url">&copy; 地圖資料由地政總署提供</a><div class="copyright-logo"></div>',
            }),
          ],
        });

        const map = new Map({ basemap: basemap });

        const mView = new MapView({
          container: "map-area",
          map: map,
          zoom: 10,
          center: new Point(
            833359.88495,
            822961.986247,
            new SpatialReference({ wkid: 2326 })
          ),
          constraints: { minZoom: 8, maxZoom: 19 },
        });

        // Create a graphics layer for the pin
        const graphicsLayer = new GraphicsLayer();
        map.add(graphicsLayer);

        // Function to search and display results
        function searchLocations(query) {
          const resultsContainer = document.getElementById("results-container");
          resultsContainer.innerHTML = ""; // Clear previous results
          graphicsLayer.removeAll(); // Clear previous pins

          if (query) {
            fetch(
              `https://geodata.gov.hk/gs/api/v1.0.0/locationSearch?q=${encodeURIComponent(
                query
              )}`
            )
              .then((response) => {
                if (!response.ok) {
                  throw new Error(
                    "Network response was not ok: " + response.statusText
                  );
                }
                return response.json();
              })
              .then((data) => {
                if (data && data.length > 0) {
                  data.forEach((location) => {
                    const coordinates = [location.x, location.y];
                    const resultItem = document.createElement("div");
                    resultItem.className = "result-item";
                    resultItem.innerText = `${location.nameZH} (${location.districtZH}) - ${location.nameEN}`;
                    resultItem.onclick = () => {
                      const point = new Point(
                        coordinates[0],
                        coordinates[1],
                        new SpatialReference({ wkid: 2326 })
                      );
                      mView.goTo({ target: point, zoom: 15 });

                      // Add pin to the map
                      const pointGraphic = new Graphic({
                        geometry: point,
                        symbol: {
                          type: "simple-marker",
                          color: "red",
                          size: "12px",
                          outline: {
                            color: "white",
                            width: 1,
                          },
                        },
                      });
                      graphicsLayer.removeAll(); // Remove previous pins
                      graphicsLayer.add(pointGraphic);
                    };
                    resultsContainer.appendChild(resultItem);
                  });
                } else {
                  alert("No results found.");
                }
              })
              .catch((error) => {
                console.error("Error fetching location:", error);
                alert("An error occurred while fetching location data.");
              });
          }
        }

        // Search as the user types
        document
          .getElementById("search-input")
          .addEventListener("input", function () {
            const query = this.value;
            searchLocations(query);
          });
      });
    </script>
  </body>
</html>
