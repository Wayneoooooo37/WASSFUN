<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ArcGIS API for JavaScript Sample with WMS Layer</title>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.29/esri/themes/light/main.css"
    />
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        font-family: sans-serif;
      }

      #map-area {
        width: 100%;
        height: 90vh; /* Use viewport height for mobile */
      }

      .search-container {
        padding: 10px;
        background-color: white;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        max-width: 300px; /* Limit width for mobile */
        width: 90%; /* Make it responsive */
      }

      .results {
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        background: white;
        border-radius: 5px;
      }

      .result-item {
        padding: 5px;
        cursor: pointer;
      }

      .result-item:hover {
        background-color: #f0f0f0;
      }

      .control-buttons {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .button {
        padding: 5px;
        background-color: #0079c1;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .button:hover {
        background-color: #005a8c;
      }

      /* Popup styles */
      .popup-table {
        width: 100%;
        border-collapse: collapse;
      }

      .popup-table th,
      .popup-table td {
        border: 1px solid #ccc;
        padding: 4px;
        text-align: left;
      }

      .popup-table th {
        background-color: #f2f2f2;
      }
    </style>
  </head>

  <body>
    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search location..." />
      <div class="results" id="results-container"></div>
    </div>

    <div class="control-buttons">
      <button class="button" id="add-point">Add Point</button>
      <button class="button" id="add-line">Add Line</button>
      <button class="button" id="add-polygon">Add Polygon</button>
      <button class="button" id="add-wms">Add WMS Layer</button>
    </div>

    <div id="map-area"></div>

    <script src="https://js.arcgis.com/4.29/"></script>
    <script>
      require([
        "esri/Map",
        "esri/Basemap",
        "esri/layers/VectorTileLayer",
        "esri/views/MapView",
        "esri/geometry/SpatialReference",
        "esri/geometry/Point",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
        "esri/layers/WMSLayer",
        "esri/geometry/Polyline",
        "esri/geometry/Polygon",
      ], function (
        Map,
        Basemap,
        VectorTileLayer,
        MapView,
        SpatialReference,
        Point,
        GraphicsLayer,
        Graphic,
        WMSLayer,
        Polyline,
        Polygon
      ) {
        const basemapVTURL =
          "https://mapapi.geodata.gov.hk/gs/api/v1.0.0/vt/basemap/HK80";

        const basemap = new Basemap({
          baseLayers: [
            new VectorTileLayer({
              url: basemapVTURL,
            }),
          ],
        });

        const map = new Map({ basemap: basemap });

        const mView = new MapView({
          container: "map-area",
          map: map,
          zoom: 10,
          center: new Point(
            833359.88495,
            822961.986247,
            new SpatialReference({ wkid: 2326 })
          ),
          constraints: { minZoom: 8, maxZoom: 19 },
        });

        // Create a graphics layer for the pins
        const graphicsLayer = new GraphicsLayer();
        map.add(graphicsLayer);

        // Add WMS Layer
        document.getElementById("add-wms").onclick = function () {
          const wmsLayer = new WMSLayer({
            url: "https://portal.csdi.gov.hk/server/services/common/lcsd_rcd_1670384557490_22821/MapServer/WMSServer",
            sublayers: [
              {
                name: "0", // Adjust this if needed to match your WMS layer names
                title: "IPPET",
              },
            ],
            visible: true,
          });
          map.add(wmsLayer);
        };

        // Function to search and display results
        function searchLocations(query) {
          const resultsContainer = document.getElementById("results-container");
          resultsContainer.innerHTML = ""; // Clear previous results
          graphicsLayer.removeAll(); // Clear previous pins

          if (query) {
            fetch(
              `https://geodata.gov.hk/gs/api/v1.0.0/locationSearch?q=${encodeURIComponent(
                query
              )}`
            )
              .then((response) => {
                if (!response.ok) {
                  throw new Error(
                    "Network response was not ok: " + response.statusText
                  );
                }
                return response.json();
              })
              .then((data) => {
                if (data && data.length > 0) {
                  data.forEach((location) => {
                    const coordinates = [location.x, location.y];
                    const resultItem = document.createElement("div");
                    resultItem.className = "result-item";
                    resultItem.innerText = `${location.nameZH} (${location.districtZH}) - ${location.nameEN}`;
                    resultItem.onclick = () => {
                      const point = new Point(
                        coordinates[0],
                        coordinates[1],
                        new SpatialReference({ wkid: 2326 })
                      );
                      mView.goTo({ target: point, zoom: 15 });

                      // Add pin to the map
                      const pointGraphic = new Graphic({
                        geometry: point,
                        symbol: {
                          type: "picture-marker",
                          url: "https://example.com/path/to/dog-icon.png", // Replace with your dog icon URL
                          width: "24px",
                          height: "24px",
                        },
                      });
                      graphicsLayer.removeAll(); // Remove previous pins
                      graphicsLayer.add(pointGraphic);
                    };
                    resultsContainer.appendChild(resultItem);
                  });
                } else {
                  alert("No results found.");
                }
              })
              .catch((error) => {
                console.error("Error fetching location:", error);
                alert("An error occurred while fetching location data.");
              });
          }
        }

        // Search as the user types
        document
          .getElementById("search-input")
          .addEventListener("input", function () {
            const query = this.value;
            searchLocations(query);
          });

        // Adding Points
        document.getElementById("add-point").onclick = function () {
          mView.on("click", function (event) {
            const point = new Point(
              event.mapPoint.longitude,
              event.mapPoint.latitude,
              new SpatialReference({ wkid: 4326 })
            );
            const pointGraphic = new Graphic({
              geometry: point,
              symbol: {
                type: "picture-marker",
                url: "https://example.com/path/to/dog-icon.png", // Replace with your dog icon URL
                width: "24px",
                height: "24px",
              },
            });
            graphicsLayer.add(pointGraphic);
            mView.popup.close(); // Close any open popups
          });
        };

        // Adding Lines
        let linePoints = [];
        document.getElementById("add-line").onclick = function () {
          mView.on("click", function (event) {
            linePoints.push([
              event.mapPoint.longitude,
              event.mapPoint.latitude,
            ]);
            if (linePoints.length > 1) {
              const polyline = new Polyline({ paths: [linePoints] });
              const lineGraphic = new Graphic({
                geometry: polyline,
                symbol: {
                  type: "simple-line",
                  color: "green",
                  width: 2,
                },
              });
              graphicsLayer.add(lineGraphic);
              linePoints = []; // Reset for the next line
            }
          });
        };

        // Adding Polygons
        let polygonPoints = [];
        document.getElementById("add-polygon").onclick = function () {
          mView.on("click", function (event) {
            polygonPoints.push([
              event.mapPoint.longitude,
              event.mapPoint.latitude,
            ]);
            if (polygonPoints.length > 2) {
              const polygon = new Polygon({ rings: [polygonPoints] });
              const polygonGraphic = new Graphic({
                geometry: polygon,
                symbol: {
                  type: "simple-fill",
                  color: [51, 51, 204, 0.3],
                  outline: { color: "black", width: 1 },
                },
              });
              graphicsLayer.add(polygonGraphic);
              polygonPoints = []; // Reset for the next polygon
            }
          });
        };
      });
    </script>
  </body>
</html>
